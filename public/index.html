<!DOCTYPE html>
<html>

<head>
    <title>Group 5 - MM802 Mini Project</title>
    <meta charset="utf-8">
    <style>
        body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        #baguazhen {
            display: block;
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            z-index: 2;
        }

        #map {
            display: inline-block;
            height: 100vh;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="baguazhen"></div>
    <div id="map"></div>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6jRWOLZKKqcc48H_KnvxWrtMkzRVGnMI&libraries=places">
    </script>
    <script type="text/javascript" src="./jquery.js"></script>
    <script type="text/javascript" src="./test.js"></script>

    <script>
        var bgColor = 'rgba(46, 39, 51, 0.75)';
        var colors = ['#FFAE57', '#FF7853', '#EA5151', '#CC3F57'];
        var maxRestaurantsToDisplay = 5; // 什么鬼名字
        var categories = ["Japanese", "Chinese", "Canadian", "Thai", "Pizza", "Vegetarian", "Italian", "coffee"];
        var data = [{
            name: '',
            itemStyle: {
                color: "#808080"
            },
            children: []
        }];
        var itemStyle = {
            star5: {
                color: colors[0]
            },
            star4: {
                color: colors[1]
            },
            star3: {
                color: colors[2]
            },
            star2: {
                color: colors[3]
            }
        };

        // Generate data.
        for (var i = 0; i < categories.length; i++) {
            data[0].children.push({
                name: "",
                itemStyle: {
                    color: colors[(i % (colors.length))]
                },
                children: []
            });
            data[0].children[i].name = categories[i];
            for (var j = 0; j < maxRestaurantsToDisplay; j++) {
                data[0].children[i].children.push({
                    name: '☆',
                    children: [{
                        name: ''
                    }]
                });
            }
        }

        var dom = document.getElementById("baguazhen");
        var myChart = echarts.init(dom);
        var app = {};
        option = null;

        // data[0] is designed to be the GoBack button.
        function updateColor() {
            var category = data[0].children;
            for (var i = 0; i < category.length; ++i) {
                var block = category[i].children;
                var bookScore = [];
                var bookScoreId;
                for (var star = 0; star < block.length; ++star) {
                    var style = (function (name) {
                        name = parseFloat(name.slice(0, 3)); // Extract the numerical part.
                        switch (true) {
                            case (name >= 4.6):
                                bookScoreId = 0;
                                return itemStyle.star5;
                            case (name < 4.6 && name >= 4.3):
                                bookScoreId = 1;
                                return itemStyle.star4;
                            case (name < 4.3 && name >= 4.0):
                                bookScoreId = 2;
                                return itemStyle.star3;
                            case (name < 4.0):
                                bookScoreId = 3;
                                return itemStyle.star2;
                            default:
                                bookScoreId = 0;
                                return itemStyle.star5;
                        }
                    })(block[star].name);

                    block[star].label = {
                        color: style.color,
                        downplay: {
                            opacity: 0.5
                        }
                    };
                    if (block[star].children) {
                        style = {
                            opacity: 1,
                            color: style.color
                        };
                        block[star].children.forEach(function (book) {
                            book.value = 1;
                            book.itemStyle = style;
                            book.label = {
                                color: style.color
                            };

                            var value = 1;
                            if (bookScoreId === 0 || bookScoreId === 3) {
                                value = 5;
                            }
                            if (bookScore[bookScoreId]) {
                                bookScore[bookScoreId].value += value;
                            } else {
                                bookScore[bookScoreId] = {
                                    color: colors[bookScoreId],
                                    value: value
                                };
                            }
                        });
                    }
                }
                category[i].itemStyle = {
                    color: category[i].itemStyle.color
                };
            }
        }

        option = {
            backgroundColor: bgColor,
            color: colors,
            series: [{
                type: 'sunburst',
                center: ['50%', '48%'],
                data: data,
                sort: function (a, b) {
                    if (a.depth === 1) {
                        return b.getValue() - a.getValue();
                    } else {
                        return a.dataIndex - b.dataIndex;
                    }
                },
                label: {
                    rotate: 'radial',
                    color: bgColor
                },
                itemStyle: {
                    borderColor: bgColor,
                    borderWidth: 2
                },
                levels: [{}, {
                    r0: 0,
                    r: 20,
                    label: {
                        rotate: 0
                    }
                }, {
                    r0: 20,
                    r: 105
                }, {
                    r0: 115,
                    r: 140,
                    itemStyle: {
                        shadowBlur: 2,
                        shadowColor: colors[2],
                        color: 'transparent'
                    },
                    label: {
                        rotate: 'tangential',
                        fontSize: 10,
                        color: colors[0]
                    }
                }, {
                    r0: 140,
                    r: 145,
                    itemStyle: {
                        shadowBlur: 80,
                        shadowColor: colors[0]
                    },
                    label: {
                        position: 'outside',
                        textShadowBlur: 5,
                        textShadowColor: '#333',
                    },
                    downplay: {
                        label: {
                            opacity: 0.5
                        }
                    }
                }]
            }]
        };;
        if (option && typeof option === "object") {
            updateColor();
            myChart.setOption(option, true);
            updateColor();
        }

        var map;
        var service;
        var places = {};
        var markers = [];
        var infowindow;
        var results;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(initMap);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function addMarker(marker) {
            var googleMarker = new google.maps.Marker(marker);
            markers.push(googleMarker);
        }

        function removeMarker(marker) {
            if(!marker) { // => remove all
                markers.map(marker => {
                    marker.setMap(null);
                })
            }
        }

        function showPlaces(cate) {
            removeMarker();

            if (cate === 'all') {
                Object.keys(places).map(cate => {
                    places[cate].map(place => {
                        addMarker(place.marker)
                    });
                });
            }

            if (places.hasOwnProperty(cate)) {
                places[cate].map(place => {
                    addMarker(place.marker)
                });
            }
        }

        function callback(cate, results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                var names = [];
                var ratings = [];
                var photos = [];

                results.map(place => {
                    names.push(place.name);
                    ratings.push(place.rating);
                    place.marker = {
                        position: place.geometry.location,
                        map: map
                    };

                    if (Array.isArray(places[cate])) {
                        places[cate].push(place);
                    } else {
                        places[cate] = [place];
                    }
                });

                data[0].children.map(child => {
                    if (child.name == cate) {
                        for (var j = 0; j < maxRestaurantsToDisplay; j++) {
                            child.children[j].name = String(ratings[j]).concat(""); //rating
                            child.children[j].children[0].name = names[j]; // name
                        }
                    }
                });

                if (option && typeof option === "object") {
                    myChart.setOption(option, true);
                    updateColor(); // Update the chart.
                }
            }
        }



        function initMap(position) {
            var location = {
                lat: 53.5232189,
                lng: -113.5285073
            }; // u of a
            if (position) {
                location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
            }

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: location
            });
            var marker = new google.maps.Marker({
                position: location,
                map: map
            });

            // Send search request for each restaurant category.
            for (var i = 0; i < categories.length; i++) {
                var textSearchReq = {
                    location: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                    radius: '200',
                    query: categories[i],
                    type: ['restaurant'],
                };

                service = new google.maps.places.PlacesService(map);
                service.textSearch(textSearchReq, callback.bind(this, categories[i]));
                //$(document).click(function(e){console.log(window.node);});
            }
        }

        getLocation();
        window.node = {
            name: 'all'
        };

        google.maps.Map.prototype.clearMarkers = function() {
            for(var i=0; i < this.markers.length; i++){
                this.markers[i].setMap(null);
            }
            this.markers = new Array();
        };

        $(document).keyup(function (e) {
            if (e.keyCode == 27) { // esc pressed
                $("#baguazhen").toggle();
                console.log(window.node);

                showPlaces(window.node.name);
            }
        });
    </script>
</body>

</html>